# Test PyPI installation
# Triggered after Release workflow completes to verify package installs correctly

name: Test Installation

on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to test (e.g., 2.10.2)'
        required: false
        default: ''

jobs:
  test-install-core:
    name: Test Core Install (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    # Only run if Release workflow succeeded
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ github.event.workflow_run.head_branch }}" ]; then
            # Extract version from tag (workflow_run trigger)
            VERSION="${{ github.event.workflow_run.head_branch }}"
            echo "version=${VERSION#v}" >> $GITHUB_OUTPUT
          else
            # Fallback: get latest from PyPI
            VERSION=$(pip index versions scitex 2>/dev/null | grep -oP 'scitex \(\K[^)]+' | head -1)
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Wait for PyPI propagation
        run: sleep 60

      - name: Install scitex (core)
        run: |
          pip install --upgrade pip
          # Retry up to 3 times with 30s delay for PyPI propagation
          for i in 1 2 3; do
            pip install scitex==${{ steps.version.outputs.version }} && break
            echo "Attempt $i failed, waiting 30s..."
            sleep 30
          done

      - name: Test core imports
        run: |
          python -c "import scitex; print(f'Version: {scitex.__version__}')"
          python -c "from scitex import io, stats, config, logging"
          echo "Core imports successful"

  test-install-all:
    name: Test Full Install (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    # Only run if Release workflow succeeded
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ github.event.workflow_run.head_branch }}" ]; then
            # Extract version from tag (workflow_run trigger)
            VERSION="${{ github.event.workflow_run.head_branch }}"
            echo "version=${VERSION#v}" >> $GITHUB_OUTPUT
          else
            # Fallback: get latest from PyPI
            VERSION=$(pip index versions scitex 2>/dev/null | grep -oP 'scitex \(\K[^)]+' | head -1)
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Wait for PyPI propagation
        run: sleep 60

      - name: Install scitex[all]
        run: |
          pip install --upgrade pip
          # Retry up to 3 times with 30s delay for PyPI propagation
          for i in 1 2 3; do
            pip install "scitex[all]==${{ steps.version.outputs.version }}" && break
            echo "Attempt $i failed, waiting 30s..."
            sleep 30
          done
        timeout-minutes: 15

      - name: Test all imports
        run: |
          python -c "import scitex; print(f'Version: {scitex.__version__}')"
          python -c "from scitex import io, plt, stats, config, logging, path"
          echo "All imports successful"
