name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # Core module tests - always run
  core-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        module:
          - io
          - path
          - str
          - dict
          - types
          - config
          - utils
          - decorators
          - logging
          - stats
          - pd
          - linalg
          - torch
          - gen
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Run ${{ matrix.module }} tests
        run: |
          PYTHONPATH=./src pytest tests/scitex/${{ matrix.module }}/ -v --tb=short -q 2>&1 | tee test-${{ matrix.module }}.log || true
          # Extract pass/fail counts
          tail -5 test-${{ matrix.module }}.log
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.module }}
          path: test-${{ matrix.module }}.log
          retention-days: 7

  # Extended module tests
  extended-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        module:
          - nn
          - ai
          - writer
          - audio
          - capture
          - cli
          - sh
          - git
          - session
          - diagram
          - resource
          - repro
          - benchmark
          - security
          - tex
          - msword
          - web
          - dev
          - dt
          - scholar
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,ml]"
      - name: Run ${{ matrix.module }} tests
        run: |
          PYTHONPATH=./src pytest tests/scitex/${{ matrix.module }}/ -v --tb=short -q 2>&1 | tee test-${{ matrix.module }}.log || true
          tail -5 test-${{ matrix.module }}.log
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.module }}
          path: test-${{ matrix.module }}.log
          retention-days: 7

  # Pending modules (future work) - allow failures
  pending-tests:
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        module:
          - dsp
          - db
          - gists
          - browser
          - plt
          - schema
          - bridge
          - fts
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,ml]"
      - name: Run ${{ matrix.module }} tests (pending)
        run: |
          PYTHONPATH=./src pytest tests/scitex/${{ matrix.module }}/ -v --tb=short -q 2>&1 | tee test-${{ matrix.module }}.log || true
          tail -5 test-${{ matrix.module }}.log
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-pending-${{ matrix.module }}
          path: test-${{ matrix.module }}.log
          retention-days: 7

  # Summary job
  test-summary:
    runs-on: ubuntu-latest
    needs: [core-tests, extended-tests]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "Core tests: ${{ needs.core-tests.result }}"
          echo "Extended tests: ${{ needs.extended-tests.result }}"
          if [[ "${{ needs.core-tests.result }}" == "failure" ]] || [[ "${{ needs.extended-tests.result }}" == "failure" ]]; then
            echo "Some tests failed"
            exit 1
          fi
          echo "All required tests passed!"
