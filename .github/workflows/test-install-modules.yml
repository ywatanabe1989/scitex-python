# Test module-level PyPI installation with pytest
# Installs each module extra and runs its corresponding tests

name: Test Module Installation

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to test (leave empty for latest)'
        required: false
        default: ''
      module:
        description: 'Specific module to test (leave empty for all)'
        required: false
        default: ''

jobs:
  # Get list of modules dynamically
  get-modules:
    name: Get Module List
    runs-on: ubuntu-latest
    outputs:
      modules: ${{ steps.modules.outputs.modules }}
    steps:
      - uses: actions/checkout@v4

      - name: Get modules
        id: modules
        run: |
          if [ -n "${{ github.event.inputs.module }}" ]; then
            # Single module specified
            echo "modules=[\"${{ github.event.inputs.module }}\"]" >> $GITHUB_OUTPUT
          else
            # Get all modules with test directories
            MODULES=$(ls -d tests/scitex/*/ 2>/dev/null | xargs -n1 basename | \
              grep -v __pycache__ | \
              jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "modules=$MODULES" >> $GITHUB_OUTPUT
          fi

  test-module:
    name: Test ${{ matrix.module }}
    needs: get-modules
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 10
      matrix:
        module: ${{ fromJson(needs.get-modules.outputs.modules) }}
        python-version: ['3.11']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ github.event.release.tag_name }}" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            echo "version=${VERSION#v}" >> $GITHUB_OUTPUT
          else
            # Get latest from PyPI
            VERSION=$(pip index versions scitex 2>/dev/null | grep -oP 'scitex \(\K[^)]+' | head -1)
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Check if module extra exists
        id: check-extra
        run: |
          # Check if this module has an optional extra in pyproject.toml
          if grep -qE "^${{ matrix.module }} = \[" pyproject.toml; then
            echo "has_extra=true" >> $GITHUB_OUTPUT
            echo "Module ${{ matrix.module }} has optional extra"
          else
            echo "has_extra=false" >> $GITHUB_OUTPUT
            echo "Module ${{ matrix.module }} has no optional extra (using core)"
          fi

      - name: Install scitex[${{ matrix.module }}]
        if: steps.check-extra.outputs.has_extra == 'true'
        run: |
          pip install --upgrade pip
          pip install "scitex[${{ matrix.module }}]==${{ steps.version.outputs.version }}"
          pip install pytest pytest-cov
        timeout-minutes: 10

      - name: Install scitex (core) for modules without extra
        if: steps.check-extra.outputs.has_extra == 'false'
        run: |
          pip install --upgrade pip
          pip install "scitex==${{ steps.version.outputs.version }}"
          pip install pytest pytest-cov
        timeout-minutes: 5

      - name: Run module tests
        run: |
          if [ -d "tests/scitex/${{ matrix.module }}" ]; then
            pytest tests/scitex/${{ matrix.module }}/ \
              -v \
              --tb=short \
              --ignore=tests/scitex/${{ matrix.module }}/__pycache__ \
              -x \
              || echo "::warning::Some tests failed for ${{ matrix.module }}"
          else
            echo "No tests found for ${{ matrix.module }}"
          fi
        timeout-minutes: 10

  summary:
    name: Test Summary
    needs: test-module
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.test-module.result }}" == "success" ]; then
            echo "✓ All module tests passed"
          else
            echo "⚠ Some module tests failed"
            exit 1
          fi
